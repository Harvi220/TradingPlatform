# –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï
## Trading Platform - Binance Data Collector & Indicators System

**–í–µ—Ä—Å–∏—è:** 2.1 FINAL (—Å WebSocket)
**–î–∞—Ç–∞:** 17 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** Production Ready - –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## EXECUTIVE SUMMARY

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å Binance –∏ —Ä–∞—Å—á–µ—Ç–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∏–∑ `task.txt`.

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ Tick-by-tick —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
- ‚úÖ –ú–∏–Ω—É—Ç–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–Ω–∏–º–∫–∏
- ‚úÖ 6 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö (TOTAL, TOTAL1, TOTAL2, TOTAL3, OTHERS, COIN)
- ‚úÖ 7 –≥–ª—É–±–∏–Ω (1.5%, 3%, 5%, 8%, 15%, 30%, 60%)
- ‚úÖ 4 –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (AVG, BID/ASK, BID/ASK TOTAL, Delta)
- ‚úÖ SPOT + FUTURES –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –¶–µ–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Real-Time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket** (–ù–û–í–û–ï!)

---

## REAL-TIME –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: REST + WebSocket

### Workflow –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

```
–≠–¢–ê–ü 1: –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (REST API)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Frontend ‚Üí GET /api/ticks/BTCUSDT
        ‚Üê –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Redis
        ‚Üí –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Å –∏—Å—Ç–æ—Ä–∏–µ–π

‚è±Ô∏è –í—Ä–µ–º—è: ~50ms
üìä –î–∞–Ω–Ω—ã–µ: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 60-120 —Ç–∏–∫–æ–≤


–≠–¢–ê–ü 2: Real-Time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (WebSocket)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Frontend ‚Üí ws.connect('ws://localhost:3001')
        ‚Üí ws.subscribe({ symbol: 'BTCUSDT' })
        ‚Üê –ü–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 100-300ms
        ‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

‚è±Ô∏è –í—Ä–µ–º—è: ~50-100ms –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç Binance
üìä –î–∞–Ω–Ω—ã–µ: –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Ç–∏–∫–∏ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ!)


–†–ï–ó–£–õ–¨–¢–ê–¢: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–±–æ–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: –ë—ã—Å—Ç—Ä–∞—è (REST –∏–∑ Redis)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ (WebSocket)
‚úÖ –ù–∞–≥—Ä—É–∑–∫–∞: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è (–±–µ–∑ polling)
‚úÖ Offline: Graceful fallback –Ω–∞ REST
```

---

## –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ task.txt](#1-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∏–∑-tasktxt)
2. [–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤](#2-–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ-—Ñ–æ—Ä–º—É–ª—ã-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#3-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
4. [Real-Time Workflow: REST + WebSocket](#4-real-time-workflow-rest--websocket)
5. [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (Prisma Schema)](#5-–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö-prisma-schema)
6. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Collector Service](#6-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-collector-service)
7. [WebSocket Server Implementation](#7-websocket-server-implementation)
8. [API Endpoints](#8-api-endpoints)
9. [Frontend WebSocket Client](#9-frontend-websocket-client)
10. [–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤](#10-–ø—Ä–∏–º–µ—Ä—ã-—Ä–∞—Å—á–µ—Ç–æ–≤)
11. [–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#11-–≤–∞–ª–∏–¥–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
12. [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#12-–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
13. [–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏](#13-–æ—Ü–µ–Ω–∫–∞-–≤—Ä–µ–º–µ–Ω–∏)

---

## 1. –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ò–ó task.txt

### 1.1 –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö

```
‚úÖ Real-time —Å–±–æ—Ä –∫–∞–∂–¥—ã–π —Ç–∏–∫ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∏–∫–æ–≤ –≤ Redis
‚úÖ –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–Ω–∏–º–∫–∏ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –≤ PostgreSQL
‚úÖ SPOT –∏ FUTURES –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —á–µ—Ä–µ–∑ WebSocket
```

### 1.2 –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–∫–ª—é—á–µ–Ω–∏—è |
|-----------|----------|------------|
| **TOTAL** | –í—Å–µ –ø–∞—Ä—ã (100 —Å–∏–º–≤–æ–ª–æ–≤) | - |
| **TOTAL1** | –í—Å–µ –±–µ–∑ BTC | BTC |
| **TOTAL2** | –í—Å–µ –±–µ–∑ BTC –∏ ETH | BTC, ETH |
| **TOTAL3** | –í—Å–µ –±–µ–∑ BTC, ETH –∏ SOL | BTC, ETH, SOL |
| **OTHERS** | –í—Å–µ –±–µ–∑ TOP 10 | BTC, ETH, XRP, BNB, SOL, TRX, DOGE, ADA, LINK, BCH |
| **COIN** | –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Ä–∞ | - |

### 1.3 TOP 10 –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è (OTHERS)

–°–æ–≥–ª–∞—Å–Ω–æ task.txt —Å—Ç—Ä–æ–∫–∏ 15-24:
1. Bitcoin (BTC) - BTCUSDT
2. Ethereum (ETH) - ETHUSDT
3. XRP (XRP) - XRPUSDT
4. BNB (BNB) - BNBUSDT
5. Solana (SOL) - SOLUSDT
6. TRON (TRX) - TRXUSDT
7. Dogecoin (DOGE) - DOGEUSDT
8. Cardano (ADA) - ADAUSDT
9. Chainlink (LINK) - LINKUSDT
10. Bitcoin Cash (BCH) - BCHUSDT

### 1.4 –ì–ª—É–±–∏–Ω—ã

```
BID/ASK –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:    1.5%, 3%, 5%, 8%, 15%, 30%
AVG –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:        60%
Delta –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:      3%, 5%, 8%, 15%, 30%

–ò—Ç–æ–≥–æ: 1.5, 3, 5, 8, 15, 30, 60 (7 –≥–ª—É–±–∏–Ω)
```

### 1.5 –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

#### **1. –û–±—â–∏–π AVG**
```
–û–ø–∏—Å–∞–Ω–∏–µ: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è delta –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–µ—Ç—ã –Ω–∞ –≥–ª—É–±–∏–Ω–µ 60%
–§–æ—Ä–º—É–ª–∞:  delta[symbol] = bid / ask
          AVG = Œ£(delta) / count

–ê—Ä–≥—É–º–µ–Ω—Ç—ã: SPOT/FUTURES, TOTAL/TOTAL1/TOTAL2/TOTAL3/OTHERS
           (–±–µ–∑ COIN - —ç—Ç–æ –û–ë–©–ò–ô –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)

–ü—Ä–∏–º–µ—Ä –∏–∑ task.txt (—Å—Ç—Ä–æ–∫–∏ 32-34):
  SOL: $197.89M bid / $331.67M ask = 0.60
  ADA: $101.01M bid / $160.73M ask = 0.63
  AVG = (0.60 + 0.63) / 2 = 0.615
```

#### **2. BID/ASK**
```
–û–ø–∏—Å–∞–Ω–∏–µ: –û–±—ä–µ–º—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≥–ª—É–±–∏–Ω–∞—Ö + DIFF
–ì–ª—É–±–∏–Ω—ã:  1.5%, 3%, 5%, 8%, 15%, 30%
DIFF:     bid - ask (–≤—ã—á–∏—Ç–∞–Ω–∏–µ)

–°–º–µ—à–∞–Ω–Ω—ã–µ DIFF (—Å—Ç—Ä–æ–∫–∞ 49):
  3B-8A   = bid[3%] - ask[8%]
  8B-3A   = bid[8%] - ask[3%]
  8A-3B   = ask[8%] - bid[3%]
  8B-30A  = bid[8%] - ask[30%]
  5B-15A  = bid[5%] - ask[15%]
  15B-5A  = bid[15%] - ask[5%]
  8B-15A  = bid[8%] - ask[15%]
  15B-8A  = bid[15%] - ask[8%]
  15B-30A = bid[15%] - ask[30%]
  30B-15A = bid[30%] - ask[15%]

–ê—Ä–≥—É–º–µ–Ω—Ç—ã: SPOT/FUTURES, TOTAL/TOTAL1/.../COIN (–≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
```

#### **3. BID/ASK TOTAL**
```
–û–ø–∏—Å–∞–Ω–∏–µ: –°—É–º–º–∞—Ä–Ω—ã–µ –æ–±—ä–µ–º—ã –ø–æ –≤—Å–µ–º—É —Ä—ã–Ω–∫—É
3 –ª–∏–Ω–∏–∏:
  - Bids: Œ£(bid) - —Å—É–º–º–∞ –≤—Å–µ—Ö –±–∏–¥–æ–≤
  - Asks: Œ£(ask) - —Å—É–º–º–∞ –≤—Å–µ—Ö –∞—Å–∫–æ–≤
  - Diff: Œ£(bid) - Œ£(ask)

–ê—Ä–≥—É–º–µ–Ω—Ç—ã: SPOT/FUTURES, TOTAL/TOTAL1/TOTAL2/TOTAL3/OTHERS
           (–±–µ–∑ COIN)
```

#### **4. Delta**
```
–û–ø–∏—Å–∞–Ω–∏–µ: –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ bid –∫ ask (–¥–µ–ª–µ–Ω–∏–µ)
–§–æ—Ä–º—É–ª–∞:  delta = bid / ask
–ì–ª—É–±–∏–Ω—ã:  3%, 5%, 8%, 15%, 30%

D TOTAL (—Å—Ç—Ä–æ–∫–∏ 61):
  –î–ª—è –≤—Å–µ–≥–æ —Ä—ã–Ω–∫–∞: Œ£(bid) / Œ£(ask)

–ü—Ä–∏–º–µ—Ä: bid=$100M, ask=$50M ‚Üí delta=2.0

–ê—Ä–≥—É–º–µ–Ω—Ç—ã: SPOT/FUTURES, TOTAL/TOTAL1/.../COIN (–≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
```

---

## 2. –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –§–û–†–ú–£–õ–´ –ò–ù–î–ò–ö–ê–¢–û–†–û–í

### 2.1 –§–æ—Ä–º—É–ª–∞ AVG (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ task.txt)

```typescript
/**
 * AVG –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
 * –°—Ç—Ä–æ–∫–∏ 31-34 task.txt
 */
function calculateAVG(
  symbols: string[],      // –°–ø–∏—Å–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  depth: 60,              // –í—Å–µ–≥–¥–∞ 60%
  marketType: 'SPOT' | 'FUTURES'
): number {
  let sumDelta = 0;
  let count = 0;

  for (const symbol of symbols) {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥–ª—É–±–∏–Ω–µ 60%
    const snapshot = getSnapshot(symbol, marketType, 60);

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è delta = bid / ask
    const delta = snapshot.bidVolumeUsd / snapshot.askVolumeUsd;

    sumDelta += delta;
    count++;
  }

  // AVG = —Å—Ä–µ–¥–Ω–µ–µ –≤—Å–µ—Ö delta
  return sumDelta / count;
}

/**
 * –ü—Ä–∏–º–µ—Ä –∏–∑ task.txt:
 * SOL: 197.89 / 331.67 = 0.5967 ‚âà 0.60
 * ADA: 101.01 / 160.73 = 0.6284 ‚âà 0.63
 * AVG = (0.60 + 0.63) / 2 = 0.615 ‚úì
 */
```

### 2.2 –§–æ—Ä–º—É–ª–∞ DIFF (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)

```typescript
/**
 * DIFF –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
 * –°—Ç—Ä–æ–∫–∏ 45-46 task.txt
 */
function calculateDIFF(
  bidVolume: number,    // –í USD
  askVolume: number     // –í USD
): number {
  // DIFF = bid - ask (–≤—ã—á–∏—Ç–∞–Ω–∏–µ)
  return bidVolume - askVolume;
}

/**
 * –°–º–µ—à–∞–Ω–Ω—ã–µ DIFF
 * –°—Ç—Ä–æ–∫–∞ 49 task.txt
 */
function calculateMixedDIFF(
  bidDepth: number,     // –ì–ª—É–±–∏–Ω–∞ –¥–ª—è bid (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3)
  askDepth: number,     // –ì–ª—É–±–∏–Ω–∞ –¥–ª—è ask (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8)
  symbol: string,
  marketType: string
): number {
  const bidSnapshot = getSnapshot(symbol, marketType, bidDepth);
  const askSnapshot = getSnapshot(symbol, marketType, askDepth);

  // –ë–µ—Ä–µ–º bid —Å –æ–¥–Ω–æ–π –≥–ª—É–±–∏–Ω—ã, ask —Å –¥—Ä—É–≥–æ–π
  return bidSnapshot.bidVolumeUsd - askSnapshot.askVolumeUsd;
}
```

### 2.3 –§–æ—Ä–º—É–ª–∞ Delta (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)

```typescript
/**
 * Delta –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
 * –°—Ç—Ä–æ–∫–∏ 57-61 task.txt
 */
function calculateDelta(
  bidVolume: number,    // –í USD
  askVolume: number     // –í USD
): number {
  // Delta = bid / ask (–¥–µ–ª–µ–Ω–∏–µ, –ù–ï –≤—ã—á–∏—Ç–∞–Ω–∏–µ!)
  return bidVolume / askVolume;
}

/**
 * D TOTAL
 * –°—Ç—Ä–æ–∫–∞ 61 task.txt
 */
function calculateDeltaTotal(
  symbols: string[],
  depth: number,
  marketType: string
): number {
  let totalBid = 0;
  let totalAsk = 0;

  for (const symbol of symbols) {
    const snapshot = getSnapshot(symbol, marketType, depth);
    totalBid += snapshot.bidVolumeUsd;
    totalAsk += snapshot.askVolumeUsd;
  }

  // D TOTAL = —Å—É–º–º–∞ –≤—Å–µ—Ö bid / —Å—É–º–º–∞ –≤—Å–µ—Ö ask
  return totalBid / totalAsk;
}

/**
 * –ü—Ä–∏–º–µ—Ä –∏–∑ task.txt (—Å—Ç—Ä–æ–∫–∞ 61):
 * Bid = $100M, Ask = $50M
 * Delta = 100 / 50 = 2.0 ‚úì
 */
```

---

## 3. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

### 3.1 –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å WebSocket

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BINANCE API                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ SPOT WebSocket   ‚îÇ        ‚îÇ FUTURES WebSocket‚îÇ          ‚îÇ
‚îÇ  ‚îÇ @bookTicker      ‚îÇ        ‚îÇ @bookTicker      ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                          ‚îÇ
            ‚îÇ  –¢–∏–∫–∏ –∫–∞–∂–¥—ã–µ 100-300ms   ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        COLLECTOR SERVICE (Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  1Ô∏è‚É£ WebSocketClient                                         ‚îÇ
‚îÇ     ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç —Ç–∏–∫–∏ –æ—Ç Binance                            ‚îÇ
‚îÇ     ‚îî‚îÄ 100 —Å–∏–º–≤–æ–ª–æ–≤ √ó 2 —Ç–∏–ø–∞ = 200 streams                 ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  2Ô∏è‚É£ DepthCalculator                                         ‚îÇ
‚îÇ     ‚îú‚îÄ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—ä–µ–º—ã –Ω–∞ 7 –≥–ª—É–±–∏–Ω–∞—Ö                   ‚îÇ
‚îÇ     ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ü–µ–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  3Ô∏è‚É£ StorageManager                                          ‚îÇ
‚îÇ     ‚îú‚îÄ –ü–∏—à–µ—Ç —Ç–∏–∫–∏ –≤ Redis (Sorted Set, TTL 2 –º–∏–Ω)         ‚îÇ
‚îÇ     ‚îú‚îÄ ‚ö° –ü—É–±–ª–∏–∫—É–µ—Ç –≤ Redis Pub/Sub (–ù–û–í–û–ï!)               ‚îÇ
‚îÇ     ‚îú‚îÄ –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É                            ‚îÇ
‚îÇ     ‚îî‚îÄ –ü–∏—à–µ—Ç —Å–Ω–∏–º–∫–∏ –≤ PostgreSQL                           ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚îÇ  Redis Pub/Sub
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   REDIS (Message Broker)                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  üì¶ STORAGE (–¥–ª—è REST API):                                 ‚îÇ
‚îÇ     ‚îú‚îÄ tick:BTCUSDT:SPOT (Sorted Set, TTL 2 –º–∏–Ω)          ‚îÇ
‚îÇ     ‚îú‚îÄ tick:ETHUSDT:SPOT (Sorted Set, TTL 2 –º–∏–Ω)          ‚îÇ
‚îÇ     ‚îî‚îÄ cache:* (–ö—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤, TTL 60 —Å–µ–∫)                 ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  üì° PUB/SUB (–¥–ª—è WebSocket):                                ‚îÇ
‚îÇ     ‚îú‚îÄ Channel "ticks" ‚Üí –≤—Å–µ —Ç–∏–∫–∏                          ‚îÇ
‚îÇ     ‚îú‚îÄ Channel "tick:BTCUSDT:SPOT" ‚Üí —Ç–æ–ª—å–∫–æ BTC SPOT      ‚îÇ
‚îÇ     ‚îú‚îÄ Channel "snapshots" ‚Üí –º–∏–Ω—É—Ç–Ω—ã–µ —Å–Ω–∏–º–∫–∏               ‚îÇ
‚îÇ     ‚îî‚îÄ Channel "indicators" ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                             ‚îÇ
        ‚îÇ  Subscribe                  ‚îÇ  Read
        ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         NEXT.JS API + WebSocket SERVER (port 3000/3001)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  üîå WebSocket Server (Socket.IO –Ω–∞ –ø–æ—Ä—Ç—É 3001):            ‚îÇ
‚îÇ     ‚îú‚îÄ –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ Redis Pub/Sub –∫–∞–Ω–∞–ª—ã              ‚îÇ
‚îÇ     ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç Collector                       ‚îÇ
‚îÇ     ‚îú‚îÄ Broadcast –∫–ª–∏–µ–Ω—Ç–∞–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏               ‚îÇ
‚îÇ     ‚îî‚îÄ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  üì° HTTP REST API (–Ω–∞ –ø–æ—Ä—Ç—É 3000):                         ‚îÇ
‚îÇ     ‚îú‚îÄ GET /api/ticks/:symbol ‚Üí –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞         ‚îÇ
‚îÇ     ‚îú‚îÄ GET /api/snapshots/:symbol ‚Üí –∏—Å—Ç–æ—Ä–∏—è                ‚îÇ
‚îÇ     ‚îú‚îÄ GET /api/indicators/* ‚Üí —Ä–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤          ‚îÇ
‚îÇ     ‚îî‚îÄ GET /api/validation/* ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö             ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                             ‚îÇ
        ‚îÇ  WebSocket                  ‚îÇ  REST
        ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  FRONTEND (Browser)                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  –≠–¢–ê–ü 1: –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (REST)                         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                         ‚îÇ
‚îÇ  fetch('/api/ticks/BTCUSDT')                               ‚îÇ
‚îÇ    .then(data => {                                          ‚îÇ
‚îÇ      // –ü–æ–ª—É—á–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫                          ‚îÇ
‚îÇ      initChart(data.ticks);                                ‚îÇ
‚îÇ    })                                                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  –≠–¢–ê–ü 2: Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (WebSocket)                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                     ‚îÇ
‚îÇ  const ws = io('ws://localhost:3001');                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ws.on('connect', () => {                                   ‚îÇ
‚îÇ    ws.emit('subscribe', {                                   ‚îÇ
‚îÇ      symbol: 'BTCUSDT',                                     ‚îÇ
‚îÇ      marketType: 'SPOT'                                     ‚îÇ
‚îÇ    });                                                      ‚îÇ
‚îÇ  });                                                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ws.on('tick', (data) => {                                  ‚îÇ
‚îÇ    // –ù–æ–≤—ã–π —Ç–∏–∫ –∫–∞–∂–¥—ã–µ 100-300ms                           ‚îÇ
‚îÇ    chart.update(data);                                     ‚îÇ
‚îÇ    updateIndicators(data);                                 ‚îÇ
‚îÇ  });                                                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ws.on('disconnect', () => {                                ‚îÇ
‚îÇ    // Fallback –Ω–∞ polling —á–µ—Ä–µ–∑ REST                       ‚îÇ
‚îÇ    startPolling();                                         ‚îÇ
‚îÇ  });                                                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 4. REAL-TIME WORKFLOW: REST + WebSocket

### 4.1 –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∂–∏–∑–Ω–∏ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TIMELINE: –û—Ç Binance –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

T=0ms     ‚îÇ Binance –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π tick
          ‚îÇ   symbol: BTCUSDT
          ‚îÇ   bestBid: 43250.50
          ‚îÇ   bestAsk: 43250.60
          ‚îÇ
T=30ms    ‚îÇ Collector –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ WebSocket
          ‚îÇ   ‚îú‚îÄ –ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ
          ‚îÇ   ‚îî‚îÄ –ü–æ–ª—É—á–∞–µ—Ç full order book (depth=1000)
          ‚îÇ
T=40ms    ‚îÇ –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–æ–≤ –Ω–∞ 7 –≥–ª—É–±–∏–Ω–∞—Ö
          ‚îÇ   ‚îú‚îÄ depth 1.5%: bid=150, ask=145
          ‚îÇ   ‚îú‚îÄ depth 3%:   bid=250, ask=240
          ‚îÇ   ‚îî‚îÄ ...
          ‚îÇ
T=45ms    ‚îÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
          ‚îÇ   ‚îú‚îÄ Sorted Set: tick:BTCUSDT:SPOT
          ‚îÇ   ‚îî‚îÄ Pub/Sub: publish('ticks', data) ‚ö°
          ‚îÇ
T=46ms    ‚îÇ Next.js WebSocket —Å–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∏–∑ Pub/Sub
          ‚îÇ   ‚îî‚îÄ subscriber.on('message', ...)
          ‚îÇ
T=47ms    ‚îÇ Broadcast –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
          ‚îÇ   ‚îî‚îÄ io.emit('tick', data)
          ‚îÇ
T=48ms    ‚îÇ Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          ‚îÇ   ‚îú‚îÄ ws.on('tick', data => {...})
          ‚îÇ   ‚îî‚îÄ chart.update(data)
          ‚îÇ
T=50ms    ‚îÇ –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω! ‚úÖ

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ò–¢–û–ì–û: ~50ms –æ—Ç Binance –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.2 –î–µ—Ç–∞–ª—å–Ω—ã–π Workflow –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

```typescript
/**
 * –®–ê–ì–ò –†–ê–ë–û–¢–´ FRONTEND –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –®–ê–ì 1: –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (REST API –∏–∑ Redis)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function initializeChart(symbol: string, marketType: string) {
  console.log('üì• Loading initial data from REST API...');

  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ –¥–∞–Ω–Ω—ã—Ö
  const response = await fetch(
    `/api/ticks/${symbol}?marketType=${marketType}&last=60`
  );

  const data = await response.json();
  // data.ticks = –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60-180 —Ç–∏–∫–æ–≤ –∏–∑ Redis

  console.log(`‚úÖ Loaded ${data.ticks.length} ticks from Redis`);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
  const chart = createChart('#chart-container');

  for (const tick of data.ticks) {
    chart.addData({
      time: tick.timestamp / 1000,
      value: tick.bestBid,
    });
  }

  console.log('üìä Chart initialized with history');

  return chart;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –®–ê–ì 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function setupRealtimeUpdates(
  chart: Chart,
  symbol: string,
  marketType: string
) {
  console.log('üîå Connecting to WebSocket...');

  const ws = io('ws://localhost:3001', {
    transports: ['websocket'],
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 10,
  });

  ws.on('connect', () => {
    console.log('‚úÖ WebSocket connected');

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª
    ws.emit('subscribe', { symbol, marketType });

    console.log(`üì° Subscribed to ${symbol} ${marketType}`);
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  ws.on('tick', (data: TickData) => {
    console.log(`‚ö° New tick: ${data.symbol} @ ${data.bestBid}`);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏!)
    chart.update({
      time: data.timestamp / 1000,
      value: data.bestBid,
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    updateIndicators(data);

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updatePriceDisplay(data.bestBid, data.bestAsk);
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –®–ê–ì 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è (Graceful Fallback)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  ws.on('disconnect', (reason) => {
    console.warn('‚ö†Ô∏è WebSocket disconnected:', reason);

    // Fallback: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ polling —á–µ—Ä–µ–∑ REST
    console.log('üîÑ Falling back to REST polling...');

    const pollingInterval = setInterval(async () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –ª–∏ WebSocket
      if (ws.connected) {
        clearInterval(pollingInterval);
        console.log('‚úÖ WebSocket reconnected, stopping polling');
        return;
      }

      // –î–µ–ª–∞–µ–º REST –∑–∞–ø—Ä–æ—Å
      const response = await fetch(
        `/api/ticks/${symbol}?marketType=${marketType}&last=1`
      );
      const data = await response.json();

      if (data.ticks.length > 0) {
        const latestTick = data.ticks[data.ticks.length - 1];
        chart.update({
          time: latestTick.timestamp / 1000,
          value: latestTick.bestBid,
        });
      }
    }, 1000); // Polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
  });

  ws.on('reconnect', (attemptNumber) => {
    console.log(`üîÑ Reconnected after ${attemptNumber} attempts`);
  });

  return ws;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function main() {
  const symbol = 'BTCUSDT';
  const marketType = 'SPOT';

  // –®–ê–ì 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis —á–µ—Ä–µ–∑ REST
  const chart = await initializeChart(symbol, marketType);

  // –®–ê–ì 2: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  const ws = await setupRealtimeUpdates(chart, symbol, marketType);

  console.log('üöÄ Application ready!');
  console.log('üìä Chart: Initialized with 60s history');
  console.log('‚ö° WebSocket: Receiving real-time updates');
}

main();
```

### 4.3 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ POLLING (–±–µ–∑ WebSocket)                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  setInterval(() => {                                      ‚îÇ
‚îÇ    fetch('/api/ticks/BTCUSDT').then(data => {            ‚îÇ
‚îÇ      updateChart(data);                                   ‚îÇ
‚îÇ    });                                                    ‚îÇ
‚îÇ  }, 1000);                                                ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞: 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏               ‚îÇ
‚îÇ  ‚ùå –ù–∞–≥—Ä—É–∑–∫–∞: 100 –∫–ª–∏–µ–Ω—Ç–æ–≤ √ó 1 req/s = 100 req/s         ‚îÇ
‚îÇ  ‚ùå –¢—Ä–∞—Ñ–∏–∫: –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã                      ‚îÇ
‚îÇ  ‚ùå –î–∞–Ω–Ω—ã–µ: –ß–∞—Å—Ç–æ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è (–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)            ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ REST + WebSocket (–Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ) ‚úÖ                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞                                    ‚îÇ
‚îÇ  const data = await fetch('/api/ticks/BTCUSDT');         ‚îÇ
‚îÇ  initChart(data);                                         ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  // Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è                                  ‚îÇ
‚îÇ  ws.on('tick', data => {                                  ‚îÇ
‚îÇ    updateChart(data);                                     ‚îÇ
‚îÇ  });                                                      ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞: <100ms (–ø–æ—á—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)                   ‚îÇ
‚îÇ  ‚úÖ –ù–∞–≥—Ä—É–∑–∫–∞: –û–¥–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ                 ‚îÇ
‚îÇ  ‚úÖ –¢—Ä–∞—Ñ–∏–∫: –¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ               ‚îÇ
‚îÇ  ‚úÖ –î–∞–Ω–Ω—ã–µ: –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ                            ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 5. –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• (Prisma Schema)

### 5.1 –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ü–µ–Ω

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// –û–°–ù–û–í–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –°–Ω–∏–º–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º
// ============================================

/// –ú–∏–Ω—É—Ç–Ω—ã–µ —Å–Ω–∏–º–∫–∏ –æ–±—ä–µ–º–æ–≤ –Ω–∞ –≥–ª—É–±–∏–Ω–∞—Ö (–¥–ª—è COIN)
model Snapshot {
  id            String   @id @default(cuid())

  /// Timestamp (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ –º–∏–Ω—É—Ç—ã)
  timestamp     DateTime @db.Timestamptz(3)

  /// –°–∏–º–≤–æ–ª (BTCUSDT, ETHUSDT, ...)
  symbol        String   @db.VarChar(20)

  /// –¢–∏–ø —Ä—ã–Ω–∫–∞
  marketType    MarketType

  /// –ì–ª—É–±–∏–Ω–∞ –≤ % (1.5, 3, 5, 8, 15, 30, 60)
  depth         Float    @db.Real

  // ===== –û–ë–™–ï–ú–´ (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ) =====
  /// –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º bid –∑–∞ –º–∏–Ω—É—Ç—É (–≤ –º–æ–Ω–µ—Ç–∞—Ö)
  bidVolume        Float @db.Real

  /// –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º ask –∑–∞ –º–∏–Ω—É—Ç—É (–≤ –º–æ–Ω–µ—Ç–∞—Ö)
  askVolume        Float @db.Real

  /// –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º bid –≤ USD
  bidVolumeUsd     Float @db.Real

  /// –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º ask –≤ USD
  askVolumeUsd     Float @db.Real

  // ===== –¶–ï–ù–´ –î–õ–Ø –í–ê–õ–ò–î–ê–¶–ò–ò =====
  /// –õ—É—á—à–∞—è —Ü–µ–Ω–∞ bid (–æ—Ç –∫–æ—Ç–æ—Ä–æ–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª—É–±–∏–Ω–∞)
  bestBid          Float @db.Real

  /// –õ—É—á—à–∞—è —Ü–µ–Ω–∞ ask (–æ—Ç –∫–æ—Ç–æ—Ä–æ–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª—É–±–∏–Ω–∞)
  bestAsk          Float @db.Real

  /// –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ = (bestBid + bestAsk) / 2
  midPrice         Float @db.Real

  /// –°–ø—Ä–µ–¥ = bestAsk - bestBid
  spread           Float @db.Real

  // ===== –ü–û–†–û–ì–û–í–´–ï –¶–ï–ù–´ –ì–õ–£–ë–ò–ù (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) =====
  /// –ü–æ—Ä–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è bid: bestBid * (1 - depth%)
  bidThreshold     Float @db.Real

  /// –ü–æ—Ä–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è ask: bestAsk * (1 + depth%)
  askThreshold     Float @db.Real

  // ===== –ú–ï–¢–ê–î–ê–ù–ù–´–ï =====
  createdAt     DateTime @default(now()) @db.Timestamptz(3)

  // ===== –ò–ù–î–ï–ö–°–´ =====
  @@unique([symbol, marketType, depth, timestamp])
  @@index([timestamp(sort: Desc)])
  @@index([symbol, marketType, depth, timestamp(sort: Desc)])
  @@index([symbol, timestamp(sort: Desc)])

  @@map("snapshots")
}

// ============================================
// –ö–ê–¢–ï–ì–û–†–ò–ò: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
// ============================================

/// –°–Ω–∏–º–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (TOTAL, TOTAL1, TOTAL2, TOTAL3, OTHERS)
model CategorySnapshot {
  id            String   @id @default(cuid())

  /// Timestamp (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ –º–∏–Ω—É—Ç—ã)
  timestamp     DateTime @db.Timestamptz(3)

  /// –ö–∞—Ç–µ–≥–æ—Ä–∏—è
  category      CategoryType

  /// –¢–∏–ø —Ä—ã–Ω–∫–∞
  marketType    MarketType

  /// –ì–ª—É–±–∏–Ω–∞ –≤ %
  depth         Float    @db.Real

  // ===== –°–£–ú–ú–ê–†–ù–´–ï –û–ë–™–ï–ú–´ =====
  /// –°—É–º–º–∞ –≤—Å–µ—Ö bid –æ–±—ä–µ–º–æ–≤ –≤ USD
  totalBidVolumeUsd  Float @db.Real

  /// –°—É–º–º–∞ –≤—Å–µ—Ö ask –æ–±—ä–µ–º–æ–≤ –≤ USD
  totalAskVolumeUsd  Float @db.Real

  // ===== –ú–ï–¢–ê–î–ê–ù–ù–´–ï =====
  /// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∞–≥—Ä–µ–≥–∞—Ç–µ
  symbolCount        Int   @db.Integer

  /// –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º
  avgMidPrice        Float @db.Real

  createdAt     DateTime @default(now()) @db.Timestamptz(3)

  // ===== –ò–ù–î–ï–ö–°–´ =====
  @@unique([category, marketType, depth, timestamp])
  @@index([timestamp(sort: Desc)])
  @@index([category, marketType, depth, timestamp(sort: Desc)])
  @@index([category, timestamp(sort: Desc)])

  @@map("category_snapshots")
}

// ============================================
// ENUMS
// ============================================

enum MarketType {
  SPOT
  FUTURES

  @@map("market_type")
}

enum CategoryType {
  TOTAL       // –í—Å–µ –ø–∞—Ä—ã
  TOTAL1      // –ë–µ–∑ BTC
  TOTAL2      // –ë–µ–∑ BTC –∏ ETH
  TOTAL3      // –ë–µ–∑ BTC, ETH –∏ SOL
  OTHERS      // –ë–µ–∑ TOP 10

  @@map("category_type")
}

// ============================================
// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ê–ë–õ–ò–¶–´
// ============================================

/// WebSocket —Å–æ–±—ã—Ç–∏—è (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
model WebSocketEvent {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now()) @db.Timestamptz(3)

  symbol      String   @db.VarChar(20)
  marketType  MarketType
  eventType   WebSocketEventType
  message     String?  @db.Text
  metadata    Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([eventType, timestamp(sort: Desc)])

  @@map("websocket_events")
}

enum WebSocketEventType {
  CONNECTED
  DISCONNECTED
  ERROR
  RECONNECTING
  SNAPSHOT_LOADED
  GAP_DETECTED
  UPDATE_FAILED

  @@map("websocket_event_type")
}

/// –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
model SystemMetric {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now()) @db.Timestamptz(3)

  metricName  String   @db.VarChar(50)
  metricValue Float    @db.Real
  metadata    Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([metricName, timestamp(sort: Desc)])

  @@map("system_metrics")
}
```

---

## 6. –°–¢–†–£–ö–¢–£–†–ê COLLECTOR SERVICE

### 6.1 –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
collector/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.ts                    # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ symbols.ts             # TOP_100_SYMBOLS, TOP_10
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ depths.ts              # DEPTH_LEVELS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ categories.ts          # CATEGORY_DEFINITIONS
‚îÇ   ‚îú‚îÄ‚îÄ websocket/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts              # WebSocket –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handler.ts             # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ calculator/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ depth-calculator.ts    # –†–∞—Å—á–µ—Ç –≥–ª—É–±–∏–Ω
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ price-validator.ts     # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω
‚îÇ   ‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis-storage.ts       # –ó–∞–ø–∏—Å—å —Ç–∏–∫–æ–≤ –≤ Redis + Pub/Sub ‚ö°
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postgres-storage.ts    # –ó–∞–ø–∏—Å—å —Å–Ω–∏–º–∫–æ–≤ –≤ PostgreSQL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ aggregator.ts          # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ collector.service.ts   # –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ logger.ts              # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ       ‚îî‚îÄ‚îÄ metrics.ts             # –ú–µ—Ç—Ä–∏–∫–∏
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ .env.example
```

### 6.2 Redis Storage —Å Pub/Sub

```typescript
// collector/src/storage/redis-storage.ts

import { getRedisClient } from './redis.client';

export class RedisStorage {
  private redis: RedisClient;

  async init() {
    this.redis = await getRedisClient();
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∏–∫ –≤ Redis –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
   */
  async saveTick(tick: TickData): Promise<void> {
    const key = `tick:${tick.symbol}:${tick.marketType}`;

    // 1Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Sorted Set (–¥–ª—è REST API)
    await this.redis.zAdd(key, {
      score: tick.timestamp,
      value: JSON.stringify(tick),
    });

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (> 2 –º–∏–Ω—É—Ç)
    const twoMinutesAgo = Date.now() - 2 * 60 * 1000;
    await this.redis.zRemRangeByScore(key, 0, twoMinutesAgo);

    // TTL
    await this.redis.expire(key, 120);

    // 2Ô∏è‚É£ ‚ö° –ü–£–ë–õ–ò–ö–£–ï–ú –°–û–ë–´–¢–ò–ï (–¥–ª—è WebSocket)
    await this.redis.publish('ticks', JSON.stringify({
      type: 'tick',
      symbol: tick.symbol,
      marketType: tick.marketType,
      data: tick,
      timestamp: Date.now(),
    }));

    // 3Ô∏è‚É£ –ü—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
    await this.redis.publish(
      `tick:${tick.symbol}:${tick.marketType}`,
      JSON.stringify(tick)
    );

    console.log(`üì° Published: ${tick.symbol} @ ${tick.bestBid}`);
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–Ω–∏–º–æ–∫ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
   */
  async saveSnapshot(snapshot: Snapshot): Promise<void> {
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL (—á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å)
    // ...

    // ‚ö° –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –æ –Ω–æ–≤–æ–º —Å–Ω–∏–º–∫–µ
    await this.redis.publish('snapshots', JSON.stringify({
      type: 'snapshot',
      symbol: snapshot.symbol,
      marketType: snapshot.marketType,
      depth: snapshot.depth,
      data: snapshot,
      timestamp: Date.now(),
    }));

    console.log(`üì° Published snapshot: ${snapshot.symbol} depth=${snapshot.depth}`);
  }

  /**
   * –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   */
  async publishIndicatorUpdate(
    indicator: string,
    category: string,
    marketType: string,
    value: number
  ): Promise<void> {
    await this.redis.publish('indicators', JSON.stringify({
      type: 'indicator',
      indicator,
      category,
      marketType,
      value,
      timestamp: Date.now(),
    }));
  }
}
```

---

## 7. WEBSOCKET SERVER IMPLEMENTATION

### 7.1 Next.js WebSocket Server

```typescript
// src/lib/websocket-server.ts

import { Server } from 'socket.io';
import { createServer } from 'http';
import { getRedisClient } from '@/backend/database/redis.client';

let io: Server | null = null;
let httpServer: any = null;

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket —Å–µ—Ä–≤–µ—Ä–∞
 */
export async function initWebSocketServer() {
  if (io) {
    console.log('[WebSocket] Server already running');
    return io;
  }

  console.log('[WebSocket] Initializing server...');

  // –°–æ–∑–¥–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è Socket.IO
  httpServer = createServer();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Socket.IO
  io = new Server(httpServer, {
    cors: {
      origin: process.env.ALLOWED_ORIGINS?.split(',') || '*',
      methods: ['GET', 'POST'],
      credentials: true,
    },
    transports: ['websocket', 'polling'],
  });

  // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Redis Pub/Sub
  const redis = await getRedisClient();
  const subscriber = redis.duplicate();
  await subscriber.connect();

  console.log('[WebSocket] Connected to Redis Pub/Sub');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –ü–û–î–ü–ò–°–ö–ê –ù–ê REDIS PUB/SUB –ö–ê–ù–ê–õ–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // 1Ô∏è‚É£ –ö–∞–Ω–∞–ª "ticks" - –≤—Å–µ —Ç–∏–∫–∏
  await subscriber.subscribe('ticks', (message) => {
    const event = JSON.parse(message);

    // Broadcast –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
    io?.emit('tick', event.data);

    console.log(`üì§ Broadcast tick: ${event.symbol} to ${io?.sockets.sockets.size} clients`);
  });

  // 2Ô∏è‚É£ –ö–∞–Ω–∞–ª "snapshots" - –º–∏–Ω—É—Ç–Ω—ã–µ —Å–Ω–∏–º–∫–∏
  await subscriber.subscribe('snapshots', (message) => {
    const event = JSON.parse(message);
    io?.emit('snapshot', event.data);
  });

  // 3Ô∏è‚É£ –ö–∞–Ω–∞–ª "indicators" - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
  await subscriber.subscribe('indicators', (message) => {
    const event = JSON.parse(message);
    io?.emit('indicator', event);
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô –ö–õ–ò–ï–ù–¢–û–í
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  io.on('connection', (socket) => {
    console.log(`[WebSocket] Client connected: ${socket.id}`);
    console.log(`[WebSocket] Total clients: ${io?.sockets.sockets.size}`);

    // –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª
    socket.on('subscribe', async (params: {
      symbol: string;
      marketType: 'SPOT' | 'FUTURES';
    }) => {
      const { symbol, marketType } = params;
      const room = `${symbol}:${marketType}`;

      // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∫ room
      socket.join(room);

      console.log(`[WebSocket] Client ${socket.id} subscribed to ${room}`);

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –≤ Redis
      const channel = `tick:${symbol}:${marketType}`;

      await subscriber.subscribe(channel, (message) => {
        const tick = JSON.parse(message);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º –≤ —ç—Ç–æ–º room
        io?.to(room).emit('tick', tick);
      });

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      socket.emit('subscribed', { symbol, marketType, room });
    });

    // –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Å–∏–º–≤–æ–ª–∞
    socket.on('unsubscribe', async (params: {
      symbol: string;
      marketType: string;
    }) => {
      const { symbol, marketType } = params;
      const room = `${symbol}:${marketType}`;

      socket.leave(room);

      console.log(`[WebSocket] Client ${socket.id} unsubscribed from ${room}`);

      socket.emit('unsubscribed', { symbol, marketType });
    });

    // Ping/Pong –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    socket.on('ping', () => {
      socket.emit('pong', { timestamp: Date.now() });
    });

    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
    socket.on('disconnect', (reason) => {
      console.log(`[WebSocket] Client disconnected: ${socket.id}, reason: ${reason}`);
      console.log(`[WebSocket] Total clients: ${io?.sockets.sockets.size}`);
    });
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3001
  const PORT = process.env.WS_PORT || 3001;
  httpServer.listen(PORT, () => {
    console.log(`[WebSocket] Server listening on port ${PORT}`);
  });

  return io;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä WebSocket —Å–µ—Ä–≤–µ—Ä–∞
 */
export function getWebSocketServer(): Server | null {
  return io;
}

/**
 * Graceful shutdown
 */
export async function closeWebSocketServer() {
  if (io) {
    console.log('[WebSocket] Closing server...');
    io.close();
    httpServer?.close();
    io = null;
    httpServer = null;
  }
}
```

### 7.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ Next.js

```typescript
// src/instrumentation.ts

export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    const { initWebSocketServer } = await import('@/lib/websocket-server');

    console.log('[Instrumentation] Starting WebSocket server...');

    await initWebSocketServer();

    console.log('[Instrumentation] ‚úì WebSocket server started');
  }
}
```

---

## 8. API ENDPOINTS

### 8.1 –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–∫–æ–≤ (REST - –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)

```typescript
/**
 * GET /api/ticks/:symbol?marketType=SPOT&last=60
 * –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–µ–∫—É–Ω–¥ —Ç–∏–∫–æ–≤ –∏–∑ Redis
 */
export async function GET(
  request: NextRequest,
  { params }: { params: { symbol: string } }
) {
  const { searchParams } = new URL(request.url);
  const symbol = params.symbol.toUpperCase();
  const marketType = (searchParams.get('marketType') || 'SPOT') as MarketType;
  const lastSeconds = parseInt(searchParams.get('last') || '60');

  const redis = await getRedisClient();
  const key = `tick:${symbol}:${marketType}`;

  // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–µ–∫—É–Ω–¥
  const now = Date.now();
  const from = now - lastSeconds * 1000;

  const ticks = await redis.zRangeByScore(key, from, now);

  return NextResponse.json({
    symbol,
    marketType,
    ticks: ticks.map(t => JSON.parse(t)),
    count: ticks.length,
    timestamp: Date.now(),
  });
}
```

### 8.2 WebSocket Status

```typescript
/**
 * GET /api/ws/status
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å WebSocket —Å–µ—Ä–≤–µ—Ä–∞
 */
import { getWebSocketServer } from '@/lib/websocket-server';

export async function GET() {
  const io = getWebSocketServer();

  if (!io) {
    return NextResponse.json({
      status: 'not_initialized',
      clients: 0,
    });
  }

  const clients = io.sockets.sockets.size;
  const rooms = Array.from(io.sockets.adapter.rooms.keys())
    .filter(room => !io.sockets.sockets.has(room)); // –§–∏–ª—å—Ç—Ä—É–µ–º socket.id

  return NextResponse.json({
    status: 'running',
    clients,
    rooms,
    timestamp: Date.now(),
  });
}
```

### 8.3 –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Ä–∞—Å—á–µ—Ç –Ω–∞ –ª–µ—Ç—É)

```typescript
/**
 * GET /api/indicators/avg?category=TOTAL&marketType=SPOT
 * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å AVG –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (depth=60 –≤—Å–µ–≥–¥–∞)
 */
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const category = (searchParams.get('category') || 'TOTAL') as CategoryType;
  const marketType = (searchParams.get('marketType') || 'SPOT') as MarketType;

  // –ö—ç—à
  const cacheKey = `cache:avg:${category}:${marketType}:60`;
  const redis = await getRedisClient();
  const cached = await redis.get(cacheKey);

  if (cached) {
    return NextResponse.json(JSON.parse(cached));
  }

  // –ü–æ–ª—É—á–∞–µ–º —Å–∏–º–≤–æ–ª—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const symbols = CATEGORY_DEFINITIONS[category].symbols;

  // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–∏–º–∫–∏ –Ω–∞ –≥–ª—É–±–∏–Ω–µ 60%
  const latestMinute = new Date();
  latestMinute.setSeconds(0, 0);

  const snapshots = await prisma.snapshot.findMany({
    where: {
      symbol: { in: symbols },
      marketType,
      depth: 60,
      timestamp: latestMinute,
    },
  });

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º AVG
  let sumDelta = 0;
  const deltas: { symbol: string; delta: number }[] = [];

  for (const snap of snapshots) {
    const delta = snap.bidVolumeUsd / snap.askVolumeUsd;
    sumDelta += delta;
    deltas.push({ symbol: snap.symbol, delta });
  }

  const avg = snapshots.length > 0 ? sumDelta / snapshots.length : 0;

  const result = {
    category,
    marketType,
    depth: 60,
    avg,
    symbolCount: snapshots.length,
    deltas: deltas.slice(0, 10),
    timestamp: Date.now(),
  };

  // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 1 –º–∏–Ω—É—Ç—É
  await redis.setEx(cacheKey, 60, JSON.stringify(result));

  return NextResponse.json(result);
}
```

---

## 9. FRONTEND WEBSOCKET CLIENT

### 9.1 React Hook –¥–ª—è WebSocket

```typescript
// src/hooks/useRealtimeData.ts

import { useEffect, useState, useRef } from 'react';
import { io, Socket } from 'socket.io-client';

interface UseRealtimeDataOptions {
  symbol: string;
  marketType: 'SPOT' | 'FUTURES';
  onTick?: (data: TickData) => void;
  onSnapshot?: (data: Snapshot) => void;
  autoReconnect?: boolean;
}

export function useRealtimeData(options: UseRealtimeDataOptions) {
  const {
    symbol,
    marketType,
    onTick,
    onSnapshot,
    autoReconnect = true,
  } = options;

  const [isConnected, setIsConnected] = useState(false);
  const [lastTick, setLastTick] = useState<TickData | null>(null);
  const socketRef = useRef<Socket | null>(null);

  useEffect(() => {
    // –≠–¢–ê–ü 1: –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ REST API
    async function loadInitialData() {
      try {
        const response = await fetch(
          `/api/ticks/${symbol}?marketType=${marketType}&last=60`
        );
        const data = await response.json();

        console.log(`üì• Loaded ${data.ticks.length} initial ticks`);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∏–∫
        if (data.ticks.length > 0) {
          const latest = data.ticks[data.ticks.length - 1];
          setLastTick(latest);
          onTick?.(latest);
        }
      } catch (error) {
        console.error('‚ùå Failed to load initial data:', error);
      }
    }

    loadInitialData();

    // –≠–¢–ê–ü 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    const ws = io(process.env.NEXT_PUBLIC_WS_URL || 'ws://localhost:3001', {
      transports: ['websocket'],
      reconnection: autoReconnect,
      reconnectionDelay: 1000,
      reconnectionAttempts: 10,
    });

    socketRef.current = ws;

    ws.on('connect', () => {
      console.log('‚úÖ WebSocket connected');
      setIsConnected(true);

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–∏–º–≤–æ–ª
      ws.emit('subscribe', { symbol, marketType });
    });

    ws.on('subscribed', (data) => {
      console.log(`üì° Subscribed to ${data.symbol} ${data.marketType}`);
    });

    // –≠–¢–ê–ü 3: –ü–æ–ª—É—á–µ–Ω–∏–µ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    ws.on('tick', (data: TickData) => {
      setLastTick(data);
      onTick?.(data);
    });

    ws.on('snapshot', (data: Snapshot) => {
      onSnapshot?.(data);
    });

    ws.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è WebSocket disconnected:', reason);
      setIsConnected(false);
    });

    ws.on('reconnect', (attemptNumber) => {
      console.log(`üîÑ Reconnected after ${attemptNumber} attempts`);
    });

    // Cleanup
    return () => {
      console.log('üîå Disconnecting WebSocket...');
      ws.emit('unsubscribe', { symbol, marketType });
      ws.disconnect();
    };
  }, [symbol, marketType]);

  return {
    isConnected,
    lastTick,
    socket: socketRef.current,
  };
}
```

### 9.2 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å real-time –≥—Ä–∞—Ñ–∏–∫–æ–º

```typescript
// src/components/RealTimeChart.tsx

'use client';

import { useRealtimeData } from '@/hooks/useRealtimeData';
import { useEffect, useRef } from 'react';
import { createChart, IChartApi } from 'lightweight-charts';

interface RealTimeChartProps {
  symbol: string;
  marketType: 'SPOT' | 'FUTURES';
}

export function RealTimeChart({ symbol, marketType }: RealTimeChartProps) {
  const chartRef = useRef<IChartApi | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º hook –¥–ª—è real-time –¥–∞–Ω–Ω—ã—Ö
  const { isConnected, lastTick } = useRealtimeData({
    symbol,
    marketType,
    onTick: (data) => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–∏–∫–∞
      if (chartRef.current) {
        chartRef.current.update({
          time: data.timestamp / 1000,
          value: data.bestBid,
        });
      }
    },
  });

  useEffect(() => {
    if (!containerRef.current) return;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫
    const chart = createChart(containerRef.current, {
      width: containerRef.current.clientWidth,
      height: 400,
      layout: {
        background: { color: '#1e1e1e' },
        textColor: '#d1d4dc',
      },
      grid: {
        vertLines: { color: '#2b2b43' },
        horzLines: { color: '#2b2b43' },
      },
    });

    const lineSeries = chart.addLineSeries({
      color: '#2962FF',
      lineWidth: 2,
    });

    chartRef.current = lineSeries;

    // Cleanup
    return () => {
      chart.remove();
    };
  }, []);

  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-2xl font-bold">{symbol} {marketType}</h2>

        <div className="flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${
            isConnected ? 'bg-green-500' : 'bg-red-500'
          }`} />
          <span className="text-sm">
            {isConnected ? 'Connected' : 'Disconnected'}
          </span>
        </div>
      </div>

      {lastTick && (
        <div className="grid grid-cols-4 gap-4 mb-4">
          <div className="bg-gray-800 p-4 rounded">
            <div className="text-sm text-gray-400">Best Bid</div>
            <div className="text-xl font-bold">${lastTick.bestBid.toFixed(2)}</div>
          </div>
          <div className="bg-gray-800 p-4 rounded">
            <div className="text-sm text-gray-400">Best Ask</div>
            <div className="text-xl font-bold">${lastTick.bestAsk.toFixed(2)}</div>
          </div>
          <div className="bg-gray-800 p-4 rounded">
            <div className="text-sm text-gray-400">Spread</div>
            <div className="text-xl font-bold">${lastTick.spread.toFixed(2)}</div>
          </div>
          <div className="bg-gray-800 p-4 rounded">
            <div className="text-sm text-gray-400">Updated</div>
            <div className="text-sm">
              {new Date(lastTick.timestamp).toLocaleTimeString()}
            </div>
          </div>
        </div>
      )}

      <div ref={containerRef} className="w-full" />
    </div>
  );
}
```

---

## 10. –ü–†–ò–ú–ï–†–´ –†–ê–°–ß–ï–¢–û–í

*(–ó–¥–µ—Å—å –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ –ø—Ä–∏–º–µ—Ä—ã, —á—Ç–æ –∏ —Ä–∞–Ω–µ–µ)*

---

## 11. –í–ê–õ–ò–î–ê–¶–ò–Ø –î–ê–ù–ù–´–•

*(–ó–¥–µ—Å—å –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –∏ —Ä–∞–Ω–µ–µ)*

---

## 12. –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î (2-3 —á–∞—Å–∞)

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `schema.prisma` (—Ü–µ–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å TimescaleDB —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `collector/`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker

### –§–∞–∑–∞ 2: Collector Service (6-8 —á–∞—Å–æ–≤)

- [ ] WebSocket –∫–ª–∏–µ–Ω—Ç (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Binance)
- [ ] Depth calculator (—Ä–∞—Å—á–µ—Ç –≥–ª—É–±–∏–Ω)
- [ ] Redis storage + **Pub/Sub** (–ù–û–í–û–ï!)
- [ ] PostgreSQL storage
- [ ] Aggregator (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)

### –§–∞–∑–∞ 3: WebSocket Server (3-4 —á–∞—Å–∞) **–ù–û–í–û–ï!**

- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Redis Pub/Sub
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤
- [ ] Room management (–ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–∏–º–≤–æ–ª—ã)
- [ ] Graceful shutdown

### –§–∞–∑–∞ 4: API Endpoints (4-6 —á–∞—Å–æ–≤)

- [ ] `/api/ticks/[symbol]` (REST –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
- [ ] `/api/snapshots/[symbol]`
- [ ] `/api/indicators/*` (–≤—Å–µ 4 –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞)
- [ ] `/api/ws/status` (—Å—Ç–∞—Ç—É—Å WebSocket)
- [ ] `/api/validation/*`

### –§–∞–∑–∞ 5: Frontend (4-6 —á–∞—Å–æ–≤) **–ù–û–í–û–ï!**

- [ ] `useRealtimeData` hook
- [ ] WebSocket –∫–ª–∏–µ–Ω—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] Real-time –≥—Ä–∞—Ñ–∏–∫ (TradingView)
- [ ] –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å live –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- [ ] Fallback –Ω–∞ polling –ø—Ä–∏ disconnect

### –§–∞–∑–∞ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (4-6 —á–∞—Å–æ–≤)

- [ ] Unit tests
- [ ] Integration tests
- [ ] WebSocket load testing (100+ –∫–ª–∏–µ–Ω—Ç–æ–≤)
- [ ] Memory profiling
- [ ] Latency testing

---

## 13. –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò

### –° Claude Code + WebSocket

| –§–∞–∑–∞ | –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ | –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ | –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–æ |
|------|--------------|-------------|---------------|
| 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | 2 —á | 3 —á | 4 —á |
| 2. Collector | 6 —á | 8 —á | 10 —á |
| 3. **WebSocket Server** | 3 —á | 4 —á | 5 —á |
| 4. API | 4 —á | 6 —á | 8 —á |
| 5. **Frontend WS Client** | 4 —á | 6 —á | 8 —á |
| 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 4 —á | 6 —á | 8 —á |
| **–ò–¢–û–ì–û** | **23 —á** | **33 —á** | **43 —á** |

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º

**–î–µ–Ω—å 1 (8 —á–∞—Å–æ–≤):**
- –§–∞–∑–∞ 1: –ë–î –∏ Docker
- –ù–∞—á–∞–ª–æ –§–∞–∑—ã 2: Collector

**–î–µ–Ω—å 2 (8 —á–∞—Å–æ–≤):**
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –§–∞–∑—ã 2: Collector + Pub/Sub
- –§–∞–∑–∞ 3: WebSocket Server

**–î–µ–Ω—å 3 (8 —á–∞—Å–æ–≤):**
- –§–∞–∑–∞ 4: API Endpoints
- –ù–∞—á–∞–ª–æ –§–∞–∑—ã 5: Frontend

**–î–µ–Ω—å 4 (8 —á–∞—Å–æ–≤):**
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –§–∞–∑—ã 5: Frontend
- –§–∞–∑–∞ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ò–¢–û–ì–û: 4-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π** —Å –ø–æ–ª–Ω—ã–º real-time —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º!

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–î–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã–≤–∞–µ—Ç** –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ task.txt
‚úÖ **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** —á–µ—Ä–µ–∑ WebSocket (<100ms –∑–∞–¥–µ—Ä–∂–∫–∞)
‚úÖ **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥** REST + WebSocket
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ** - Redis Pub/Sub –∫–∞–∫ message broker
‚úÖ **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ** - graceful fallback –Ω–∞ polling
‚úÖ **Production-ready** - –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** Claude Code
**–î–ª—è –ø—Ä–æ–µ–∫—Ç–∞:** Trading Platform
**–í–µ—Ä—Å–∏—è:** 2.1 FINAL (—Å WebSocket)
**–î–∞—Ç–∞:** 17 –Ω–æ—è–±—Ä—è 2025
